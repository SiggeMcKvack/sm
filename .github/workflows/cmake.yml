name: CMake Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: ${{ matrix.os }} - ${{ matrix.arch }} - ${{ matrix.build_type }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          # Ubuntu builds (x86_64 only - arm64 requires self-hosted runners)
          - os: ubuntu-latest
            arch: x86_64
            build_type: Debug
          - os: ubuntu-latest
            arch: x86_64
            build_type: Release

          # Windows builds (x86_64 and x86)
          - os: windows-latest
            arch: x86_64
            build_type: Debug
            cmake_arch: x64
          - os: windows-latest
            arch: x86_64
            build_type: Release
            cmake_arch: x64
          - os: windows-latest
            arch: x86
            build_type: Debug
            cmake_arch: Win32
          - os: windows-latest
            arch: x86
            build_type: Release
            cmake_arch: Win32

          # macOS builds (x86_64 and arm64 universal)
          - os: macos-latest
            arch: x86_64
            build_type: Debug
            cmake_arch: x86_64
          - os: macos-latest
            arch: x86_64
            build_type: Release
            cmake_arch: x86_64
          - os: macos-latest
            arch: arm64
            build_type: Debug
            cmake_arch: arm64
          - os: macos-latest
            arch: arm64
            build_type: Release
            cmake_arch: arm64

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # Install SDL2 dependencies per platform
    - name: Install SDL2 (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y libsdl2-dev

    - name: Install SDL2 (macOS)
      if: runner.os == 'macOS'
      run: brew install sdl2

    - name: Install SDL2 (Windows x64)
      if: runner.os == 'Windows' && matrix.arch == 'x86_64'
      run: |
        vcpkg install sdl2:x64-windows
        echo "CMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake" >> $GITHUB_ENV
      shell: bash

    - name: Install SDL2 (Windows x86)
      if: runner.os == 'Windows' && matrix.arch == 'x86'
      run: |
        vcpkg install sdl2:x86-windows
        echo "CMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake" >> $GITHUB_ENV
      shell: bash

    # Configure CMake
    - name: Configure CMake (Unix)
      if: runner.os != 'Windows'
      run: |
        if [ "${{ matrix.cmake_arch }}" != "" ]; then
          cmake -B build -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} -DCMAKE_OSX_ARCHITECTURES=${{ matrix.cmake_arch }}
        else
          cmake -B build -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}
        fi
      shell: bash

    - name: Configure CMake (Windows)
      if: runner.os == 'Windows'
      run: |
        cmake -B build -A ${{ matrix.cmake_arch }} -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}
      shell: bash

    # Build
    - name: Build
      run: cmake --build build --config ${{ matrix.build_type }} -j 4
      shell: bash

    # Determine executable name and location
    - name: Set executable path (Unix)
      if: runner.os != 'Windows'
      run: echo "EXECUTABLE_PATH=sm" >> $GITHUB_ENV
      shell: bash

    - name: Set executable path (Windows)
      if: runner.os == 'Windows'
      run: echo "EXECUTABLE_PATH=sm.exe" >> $GITHUB_ENV
      shell: bash

    # Upload build artifacts
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: sm-${{ matrix.os }}-${{ matrix.arch }}-${{ matrix.build_type }}
        path: ${{ env.EXECUTABLE_PATH }}
        if-no-files-found: error

    # Display build info
    - name: Display build info (Unix)
      if: runner.os != 'Windows'
      run: |
        ls -lh sm
        file sm
      shell: bash

    - name: Display build info (Windows)
      if: runner.os == 'Windows'
      run: |
        dir sm.exe
      shell: bash
